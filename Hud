--[[
   SCRIPT  LUIS - LIBRARY GUI BASE (SCROLLABLE)

  Este es el c贸digo base que crea el HUD oscuro, movible y las secciones colapsables con scroll.
  Se exporta a la variable global _G.LuaLibrary para que el script constructor lo use.
--]]

local SCRIPT_NAME = "SCRIPT  LUIS"
local LIBRARY_WIDTH = 250 -- Ancho fijo del HUD
local SECTION_MAX_HEIGHT = 200 -- Altura m谩xima de la secci贸n expandida para habilitar scroll

local LibraryGUI = {}
LibraryGUI.__index = LibraryGUI

--- Constructor: Inicializa y devuelve la nueva instancia de la librer铆a.
function LibraryGUI.new()
    local self = setmetatable({}, LibraryGUI)

    local Player = game.Players.LocalPlayer
    self.ScreenGui = Instance.new("ScreenGui")
    self.ScreenGui.Name = "Library_GUI_Root"
    self.ScreenGui.Parent = Player:WaitForChild("PlayerGui")
    
    -- Marco Principal (El Contenedor del HUD)
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, LIBRARY_WIDTH, 0, 30)
    mainFrame.Position = UDim2.new(0.05, 0, 0.5, -15)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderColor3 = Color3.fromRGB(0, 0, 0)
    mainFrame.BorderSizePixel = 1
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = self.ScreenGui
    self.MainFrame = mainFrame

    -- Layout (Organizador Principal)
    local listLayout = Instance.new("UIListLayout")
    listLayout.Name = "MainLayout"
    listLayout.Padding = UDim.new(0, 2)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Parent = mainFrame
    
    -- Funci贸n para mantener el MainFrame ajustado al contenido
    local function updateFrameSize()
        mainFrame.Size = UDim2.new(0, LIBRARY_WIDTH, 0, listLayout.AbsoluteContentSize.Y + 2)
    end

    listLayout.ChildAdded:Connect(updateFrameSize)
    listLayout.ChildRemoved:Connect(updateFrameSize)
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateFrameSize)

    -- Encabezado (T铆tulo)
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 30)
    header.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    header.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    titleLabel.BackgroundTransparency = 0.5
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextScaled = true
    titleLabel.Text = SCRIPT_NAME
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextWrapped = true
    titleLabel.Parent = header
    
    return self
end

--- M茅todo: Crea una nueva secci贸n colapsable (Carpeta) y Desplazable.
-- @param name (string): El nombre que aparecer谩 en el encabezado de la secci贸n.
-- @return (table): Una tabla con los m茅todos `addButton` y `getFrame`.
function LibraryGUI:addSection(name)
    local mainFrame = self.MainFrame

    local sectionFrame = Instance.new("Frame")
    sectionFrame.Name = name:gsub("%s+", "_") .. "_Section"
    sectionFrame.Size = UDim2.new(1, 0, 0, 30)
    sectionFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    sectionFrame.Parent = mainFrame

    -- SCROLLINGFRAME para el contenido
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "Content"
    contentFrame.Size = UDim2.new(1, 0, 0, 0) -- Altura 0: colapsado
    contentFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    contentFrame.BackgroundTransparency = 0
    contentFrame.BorderSizePixel = 0
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    contentFrame.ScrollBarThickness = 6
    contentFrame.Parent = sectionFrame

    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Name = "ContentLayout"
    contentLayout.Padding = UDim.new(0, 2)
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Parent = contentFrame

    -- Actualiza el Canvas del ScrollingFrame para permitir el scroll
    local function updateCanvasSize()
        local contentSizeY = contentLayout.AbsoluteContentSize.Y
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, contentSizeY)
    end

    contentLayout.ChildAdded:Connect(updateCanvasSize)
    contentLayout.ChildRemoved:Connect(updateCanvasSize)
    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)

    -- Encabezado de la secci贸n (Bot贸n de Toggle)
    local sectionHeader = Instance.new("TextButton")
    sectionHeader.Name = "SectionHeader"
    sectionHeader.Size = UDim2.new(1, 0, 0, 30)
    sectionHeader.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    sectionHeader.TextColor3 = Color3.fromRGB(200, 200, 200)
    sectionHeader.Text = name .. "  v" -- 'v' indica colapsado
    sectionHeader.Font = Enum.Font.SourceSans
    sectionHeader.TextSize = 16
    sectionHeader.TextXAlignment = Enum.TextXAlignment.Left
    sectionHeader.Parent = sectionFrame

    local isExpanded = false

    -- LGICA DE TOGGLE (CARPETA SCROLLABLE)
    sectionHeader.MouseButton1Click:Connect(function()
        isExpanded = not isExpanded

        if isExpanded then
            -- Expandir: Usa la altura m谩xima definida (SECTION_MAX_HEIGHT)
            local targetHeight = SECTION_MAX_HEIGHT
            contentFrame:TweenSize(UDim2.new(1, 0, 0, targetHeight), "Out", "Quad", 0.2, true)
            sectionHeader.Text = name .. "  -"
        else
            -- Colapsar
            contentFrame:TweenSize(UDim2.new(1, 0, 0, 0), "Out", "Quad", 0.2, true)
            sectionHeader.Text = name .. "  v"
        end
    end)
    
    -- Objeto de retorno de la secci贸n
    return {
        ContentFrame = contentFrame,
        -- M茅todo clave: A帽adir bot贸n dentro de esta secci贸n
        addButton = function(buttonName, callback)
            local button = Instance.new("TextButton")
            button.Name = buttonName:gsub("%s+", "_")
            
            -- Se ajusta el ancho para dejar espacio a la barra de scroll
            button.Size = UDim2.new(1, -12, 0, 25) 
            button.Position = UDim2.new(0, 6, 0, 0) 
            
            button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            button.TextColor3 = Color3.fromRGB(255, 255, 255)
            button.Text = buttonName
            button.Font = Enum.Font.SourceSans
            button.TextSize = 14
            button.Parent = contentFrame

            if type(callback) == "function" then
                button.MouseButton1Click:Connect(callback)
            end
            
            updateCanvasSize()
            
            return button
        end,
        getFrame = function() return sectionFrame end,
    }
end

-- Exportar la librer铆a para uso externo
_G.LuaLibrary = LibraryGUI
