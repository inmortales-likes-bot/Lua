-- Carga de la UI/HUD
local RainbowUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/inmortales-likes-bot/Lua/refs/heads/main/Hud"))()
local hud = RainbowUI:CreateWindow(230, 300) 

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- =========================
-- Variables y utilidades
-- =========================

-- Variables de control (bot√≥n BUSCAR)
local teleporting = false
local teleportObjectName = nil
local notifiedNoObjects = false
local notifiedError = false
local TELEPORT_INTERVAL = 0.1 

-- Variables de control (ciclo PICKUPS)
local multiTeleporting = false
local multiCancelRequested = false
local MULTI_TELEPORT_INTERVAL = 2.0 
local multiNotifiedNoObjects = false
local multiNotifiedError = false
local multiPickupSlotNames = {
    "RevealPickupsSteveEagle",
    "RevealPickupsSteveGecko",
    "RevealPickupsSteveMantisShrimp",
    "RevealPickupsSteveSnowLeopard",
}

-- Variables de control (ciclo STICKERS)
local stickerTeleporting = false
local stickerCancelRequested = false
local STICKER_TELEPORT_INTERVAL = 2.0 
local stickerNotifiedNoObjects = false
local stickerNotifiedError = false

-- Lista de rutas relativas a workspace
local stickerPaths = {
    "Stickers.Cheetah.CheckpointNoSticker00A",
    "ActiveStickers.d6001",
    "Stickers.Cheetah.CheckpointNoSticker01A",
    "Stickers.Cheetah.CheckpointNoSticker01B",
    "ActiveStickers.d6002",
    "Stickers.Cheetah.CheckpointNoSticker02A",
    "ActiveStickers.d6003",
    "ActiveStickers.d6004",
    "ActiveStickers.d6005",
    "ActiveStickers.d6006",
    "Stickers.SnowLeopard.CheckpointNoSticker06A",
    "Stickers.SnowLeopard.CheckpointNoSticker06B",
    "ActiveStickers.d6007",
    "Stickers.SnowLeopard.CheckpointNoSticker07A",
    "ActiveStickers.d6008",
    "Stickers.SnowLeopard.CheckpointNoSticker08A",
    "ActiveStickers.d6009",
    "Stickers.SnowLeopard.CheckpointNoSticker09A",
    "ActiveStickers.d6010",
    "ActiveStickers.d6011",
    "ActiveStickers.d6012",
    "Stickers.Eagle.CheckpointNoSticker12A",
    "Stickers.Eagle.CheckpointNoSticker12A",
    "Stickers.Eagle.CheckpointNoSticker12B",
    "ActiveStickers.d6013",
    "Stickers.Eagle.CheckpointNoSticker13A",
    "Stickers.Eagle.CheckpointNoSticker14A",
    "ActiveStickers.d6014",
    "ActiveStickers.d6015",
}

-- Variables de control (Plataforma)
local platform = nil
local platformFollowConn = nil
local platformManualEnabled = false 
local platformForceDisabled = false 
local PLATFORM_SIZE = Vector3.new(6, 1, 6) 
local PLATFORM_TRANSPARENCY = 0.35
local PLATFORM_COLOR = Color3.fromRGB(30, 144, 255) 
local platformYOffset = 0.1 

-- =========================
-- Funciones de Plataforma
-- =========================

local function destroyPlatform()
    if platformFollowConn then
        pcall(function() platformFollowConn:Disconnect() end)
        platformFollowConn = nil
    end
    if platform and platform.Parent then
        pcall(function() platform:Destroy() end)
    end
    platform = nil
    if hud and hud.Notify then hud:Notify("Plataforma desactivada") end
end

local function createPlatform()
    if platformForceDisabled then return end
    if platform and platform.Parent then return end
    local character = LocalPlayer and LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local p = Instance.new("Part")
    p.Name = "TeleportPlatform_" .. tostring(LocalPlayer and LocalPlayer.UserId or "Local")
    p.Size = PLATFORM_SIZE
    p.Anchored = true
    p.CanCollide = true
    p.Transparency = PLATFORM_TRANSPARENCY
    p.Material = Enum.Material.SmoothPlastic
    p.Color = PLATFORM_COLOR
    p.TopSurface = Enum.SurfaceType.Smooth
    p.BottomSurface = Enum.SurfaceType.Smooth
    p.Parent = workspace

    local hrpSizeY = (hrp.Size and hrp.Size.Y) or 2
    local yOffset = (hrpSizeY / 2) + (p.Size.Y / 2) + 0.1
    platformYOffset = yOffset
    p.CFrame = CFrame.new(hrp.Position - Vector3.new(0, yOffset, 0))

    platform = p

    platformFollowConn = RunService.Heartbeat:Connect(function()
        if not LocalPlayer or not LocalPlayer.Character then
            destroyPlatform()
            return
        end
        local curHrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not curHrp then
            destroyPlatform()
            return
        end
        local currentY = platform and platform.Parent and platform.Position.Y or (curHrp.Position.Y - platformYOffset)
        local targetPos = Vector3.new(curHrp.Position.X, currentY, curHrp.Position.Z)
        platform.CFrame = CFrame.new(targetPos)
    end)

    if hud and hud.Notify then hud:Notify("Plataforma activada") end
end

local function updatePlatformState()
    if platformForceDisabled then
        if platform and platform.Parent then
            pcall(destroyPlatform)
        end
        return
    end

    if teleporting or multiTeleporting or stickerTeleporting or platformManualEnabled then
        if not platform or not platform.Parent then
            pcall(createPlatform)
        end
    else
        if platform and platform.Parent then
            pcall(destroyPlatform)
        end
    end
end

if LocalPlayer then
    LocalPlayer.CharacterAdded:Connect(function(char)
        wait(0.1)
        if platform and platform.Parent then
            pcall(destroyPlatform)
            wait(0.05)
            pcall(function()
                if not platformForceDisabled then createPlatform() end
            end)
        end
    end)
end

local function ensurePlatformUnderCharacterInstant()
    if not platform or not platform.Parent then return end
    local character = LocalPlayer and LocalPlayer.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local yOffset = platformYOffset or (((hrp.Size and hrp.Size.Y) or 2) / 2 + (platform.Size.Y / 2) + 0.1)
    platform.CFrame = CFrame.new(hrp.Position - Vector3.new(0, yOffset, 0))
end

-- =========================
-- Funciones de Teletransporte Core
-- =========================

local function doWinTeleport()
    local player = LocalPlayer
    local success, destination = pcall(function()
        return game.Workspace.Utility.Teleporters.Portal_to_Wc.Portal["Canvas Clouds"]:FindFirstChild("Cylinder")
    end)

    if success and destination then
        pcall(function()
            if player and player.Character and player.Character.PrimaryPart then
                player.Character:SetPrimaryPartCFrame(destination.CFrame)
                pcall(ensurePlatformUnderCharacterInstant)
                if hud and hud.Notify then hud:Notify("Teletransportado a GANAR") end
            end
        end)
    else
        if hud and hud.Notify then hud:Notify("Destino GANAR no encontrado") end
    end
end

local function teleportToInstance(instance)
    if not instance then return false end

    local targetCFrame = nil
    if instance:IsA("BasePart") then
        targetCFrame = instance.CFrame
    elseif instance:IsA("Model") and instance.PrimaryPart then
        targetCFrame = instance.PrimaryPart.CFrame
    end

    if targetCFrame then
        local success, err = pcall(function()
            local player = LocalPlayer
            if player and player.Character and player.Character.PrimaryPart then
                player.Character:SetPrimaryPartCFrame(targetCFrame)
                pcall(ensurePlatformUnderCharacterInstant)
            end
        end)
        return success
    end

    return false
end

local function teleportToObject(objectName)
    if not objectName then return false end

    local pickupsFolder = game.Workspace:FindFirstChild("Pickups")
    if not pickupsFolder then return false end

    local object = pickupsFolder:FindFirstChild(objectName)
    if not object then return false end

    if object:IsA("Model") and object.PrimaryPart then
        return teleportToInstance(object.PrimaryPart)
    else
        return teleportToInstance(object)
    end
end

-- =========================
-- Bucle BUSCAR (Continua)
-- =========================

local function startTeleportLoop()
    spawn(function()
        while teleporting do
            local found = teleportToObject(teleportObjectName)

            if found then
                if hud and hud.Notify then hud:Notify("Objeto encontrado (auto-win desactivado). Usa el bot√≥n GANAR.") end
                if notifiedNoObjects then notifiedNoObjects = false end
            else
                if not notifiedNoObjects and hud and hud.Notify then
                    hud:Notify("No hay objetos")
                    notifiedNoObjects = true
                end
            end
            wait(TELEPORT_INTERVAL)
        end
        updatePlatformState()
    end)
end

-- =========================
-- Bucle PICKUPS (Pasada √∫nica)
-- =========================

local function gatherMultiTargets()
    local targets = {}
    local slotsRoot = workspace:FindFirstChild("PickupSlots")
    if not slotsRoot then return targets end

    for _, slotName in ipairs(multiPickupSlotNames) do
        local slot = slotsRoot:FindFirstChild(slotName)
        if slot then
            local def = slot:FindFirstChild("Default")
            if def then
                table.insert(targets, def)
            end
        end
    end
    return targets
end

local function startMultiTeleportOnce()
    spawn(function()
        local targets = gatherMultiTargets()

        if #targets == 0 then
            if not multiNotifiedNoObjects and hud and hud.Notify then
                hud:Notify("No hay pickups disponibles")
                multiNotifiedNoObjects = true
            end
            multiTeleporting = false
            if hud and hud.Notify then hud:Notify("Ciclo de pickups finalizado (sin targets)") end
            updatePlatformState()
            return
        end

        for i = 1, #targets do
            local target = targets[i]

            local ok = false
            local success, err = pcall(function()
                ok = teleportToInstance(target)
            end)

            if not success or not ok then
                if not multiNotifiedError and hud and hud.Notify then
                    hud:Notify("Error o pickup no v√°lido en √≠ndice " .. tostring(i))
                    multiNotifiedError = true
                end
            else
                if hud and hud.Notify then
                    hud:Notify("Teletransportado a pickup (" .. tostring(i) .. ")")
                end
                if multiNotifiedError then multiNotifiedError = false end
            end

            wait(MULTI_TELEPORT_INTERVAL)
        end

        multiTeleporting = false
        multiCancelRequested = false
        if hud and hud.Notify then hud:Notify("Ciclo de pickups finalizado") end
        updatePlatformState()
    end)
end

-- =========================
-- Bucle STICKERS (Pasada √∫nica)
-- =========================

local function findNodeByPath(path)
    local node = workspace
    for seg in string.gmatch(path, "[^%.]+") do
        if node then
            node = node:FindFirstChild(seg)
        else
            break
        end
    end
    return node
end

local function startStickerTeleportOnce()
    spawn(function()
        local targets = {}
        for _, relPath in ipairs(stickerPaths) do
            local node = findNodeByPath(relPath)
            if node then
                local touch = node:FindFirstChild("Touch")
                if touch then table.insert(targets, touch) end
            end
        end

        if #targets == 0 then
            if not stickerNotifiedNoObjects and hud and hud.Notify then
                hud:Notify("No hay stickers disponibles")
                stickerNotifiedNoObjects = true
            end
            stickerTeleporting = false
            if hud and hud.Notify then hud:Notify("Ciclo de stickers finalizado") end
            updatePlatformState()
            return
        end

        for i = 1, #targets do
            local target = targets[i]
            local ok = false
            local success, err = pcall(function()
                ok = teleportToInstance(target)
            end)
            if not success or not ok then
                if not stickerNotifiedError and hud and hud.Notify then
                    hud:Notify("Error o sticker no v√°lido en √≠ndice " .. tostring(i))
                    stickerNotifiedError = true
                end
            else
                if hud and hud.Notify then
                    hud:Notify("Teletransportado a sticker (" .. tostring(i) .. ")")
                end
                if stickerNotifiedError then stickerNotifiedError = false end
            end
            wait(STICKER_TELEPORT_INTERVAL)
        end

        stickerTeleporting = false
        stickerCancelRequested = false
        if hud and hud.Notify then hud:Notify("Ciclo de stickers finalizado") end
        updatePlatformState()
    end)
end


-- =========================
-- Handlers para los Toggles (Adaptados a 'state')
-- =========================

local function handleToggleTeleporting(state, objectName)
    if state then
        teleportObjectName = objectName
        teleporting = true
        startTeleportLoop()
        if hud and hud.Notify then hud:Notify("B√∫squeda de " .. objectName .. " activada") end
    else
        teleporting = false
        teleportObjectName = nil
        if hud and hud.Notify then hud:Notify("Opci√≥n desactivada") end
        notifiedNoObjects = false
        notifiedError = false
    end
    updatePlatformState()
end

local function handleToggleMultiTeleport(state)
    if state then
        multiTeleporting = true
        multiCancelRequested = false
        if hud and hud.Notify then hud:Notify("Iniciando pasada de pickups") end
        startMultiTeleportOnce()
    else
        multiCancelRequested = true
        if hud and hud.Notify then hud:Notify("Solicitud de cancelaci√≥n recibida") end
    end
    updatePlatformState()
end

local function handleToggleStickerTeleport(state)
    if state then
        stickerTeleporting = true
        stickerCancelRequested = false
        if hud and hud.Notify then hud:Notify("Iniciando pasada de stickers") end
        startStickerTeleportOnce()
    else
        stickerCancelRequested = true
        if hud and hud.Notify then hud:Notify("Solicitud de cancelaci√≥n recibida") end
    end
    updatePlatformState()
end

local function handleTogglePlatform(state)
    if state then
        platformManualEnabled = true
        platformForceDisabled = false
        pcall(createPlatform)
        if hud and hud.Notify then hud:Notify("Plataforma manual: ON") end
    else
        platformManualEnabled = false
        platformForceDisabled = true
        pcall(destroyPlatform)
        if hud and hud.Notify then hud:Notify("Plataforma manual: OFF (forzada)") end
    end
    updatePlatformState()
end


-- =========================
-- ESTRUCTURA DE SECCIONES (Nombres Finales)
-- =========================

-- 1. SECCI√ìN: B√∫squeda R√°pida
local sectionRecoleccion = hud:AddSection("üîé B√∫squeda R√°pida")

sectionRecoleccion:AddToggle("OBJETOS üó∫Ô∏è", false, function(state)
    local objectNames = {"Default"} 
    local firstObjectName = objectNames[1]
    handleToggleTeleporting(state, firstObjectName)
end)

sectionRecoleccion:AddToggle("NPC + üîÅ", false, function(state)
    handleToggleMultiTeleport(state)
end)

-- 2. SECCI√ìN: Checkpoints
local sectionMapas = hud:AddSection("üö© CHECKPOINTS")

sectionMapas:AddToggle("BUSCAR üîÅ", false, function(state)
    handleToggleStickerTeleport(state)
end)

-- 3. SECCI√ìN: Finalizar y Utilidades
local sectionUtilidades = hud:AddSection("üõ†Ô∏è Utilidades y üèÜ Final")

sectionUtilidades:AddButton("GANAR üèÅ", function()
    doWinTeleport()
end)

sectionUtilidades:AddToggle("PLATAFORMA Anti-Ca√≠da üü¶", false, function(state)
    handleTogglePlatform(state)
end)
